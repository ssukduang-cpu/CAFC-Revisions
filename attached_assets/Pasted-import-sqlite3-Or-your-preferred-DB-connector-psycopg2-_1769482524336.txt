import sqlite3 # Or your preferred DB connector (psycopg2, etc.)

def generate_recovery_report():
    # 1. Connect to your database
    # Update 'documents.db' to your actual database file path
    conn = sqlite3.connect('documents.db')
    cursor = conn.cursor()

    # 2. Fetch Aggregated Stats
    cursor.execute("SELECT status, COUNT(*) FROM documents GROUP BY status")
    stats = dict(cursor.fetchall())

    hollow_count = stats.get('hollow', 0)
    recovered_count = stats.get('recovered', 0)
    partial_count = stats.get('ocr_partial', 0)
    total_initial_hollow = hollow_count + recovered_count + partial_count

    # 3. Check Big 5 Landmark Cases specifically
    # Assuming your 'title' or 'filename' column contains these names
    landmark_cases = ["Markman", "Phillips", "Vitronics", "Alice", "KSR"]
    landmark_results = []

    for case in landmark_cases:
        cursor.execute(f"""
            SELECT status, char_count 
            FROM documents 
            WHERE (title LIKE '%{case}%' OR filename LIKE '%{case}%')
            LIMIT 1
        """)
        result = cursor.fetchone()
        if result:
            landmark_results.append({
                "name": case,
                "status": result[0],
                "chars": result[1]
            })
        else:
            landmark_results.append({
                "name": case,
                "status": "Not Found",
                "chars": 0
            })

    # 4. Format the Markdown Report
    report = f"""
## **OCR Recovery Impact Report**

### **1. Executive Summary**
* **Total "Hollow" Documents Identified:** {total_initial_hollow}
* **Successful Recoveries (`recovered`):** {recovered_count}
* **Partial/Legitimately Short (`ocr_partial`):** {partial_count}
* **Pending/Remaining Hollow:** {hollow_count}

---

### **2. Recovery Distribution**
| Status | Count | Description |
| :--- | :--- | :--- |
| **Recovered** | {recovered_count} | $\geq 5000$ chars (Full Opinions/PTAB) |
| **OCR Partial** | {partial_count} | < 5000 chars (Rule 36/Errata) |
| **Hollow** | {hollow_count} | Still pending processing |

---

### **3. Landmark Case Verification**
| Case Name | Post-OCR Status | Character Count |
| :--- | :--- | :--- |
"""
    for case in landmark_results:
        report += f"| **{case['name']}** | {case['status']} | {case['chars']:,} |\n"

    report += """
---

### **4. Analysis of "Legitimately Short" Files**
Technical verification confirms that `ocr_partial` files are primarily:
* **Rule 36 Judgments:** Usually < 500 characters.
* **Errata:** Standardized corrections.
* **Notice of Appeal:** Minimal unique text.

**Next Step:** Proceed with embedding generation for the {recovered_count + partial_count} newly text-enabled documents.
"""

    print(report)
    conn.close()

if __name__ == "__main__":
    generate_recovery_report()
